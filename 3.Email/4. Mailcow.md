
### Download Mailcow (Mail Stack)

cd /opt git clone https://github.com/mailcow/mailcow-dockerized cd mailcow-dockerized



## Add Official Docker Repo

sudo apt update
sudo apt install -y ca-certificates curl gnupg

sudo install -m 0755 -d /etc/apt/keyrings

curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
  $(lsb_release -cs) stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update



### Generate Config

Internally, this configures:
- TLS certificates
- Postfix hostname
- DKIM keys
- Webmail URL
- Dovecot IMAP domain

```
./generate_config.sh
```

Hostname (FQDN): mail.rishabhsoni.in
Asia/Kolkata
Branch = master
snake-oil cert - Temporary self-signed TLS cert (used before Let's Encrypt is ready)


### Pull and Start Mail Server

Run these 2 commands to:
- ðŸ”½ Download all services
- ðŸš€ Start the entire mail server backend

```
docker compose pull 
```

```
docker compose up -d
```

ðŸ“Œ **This is where you actually boot up:**
- `Postfix` (MTA + MSA)
- `Dovecot` (MDA + IMAP)
- `Rspamd` (spam filter + DKIM signer)
- `Redis`, `MariaDB`, `SOGo`, `Watchdog`, `ACME`, etc.

After this, youâ€™ll have a working internal mail system.

âš ï¸ Make sure:
- Your VPS is accessible on ports **25, 465, 587, 993, 80, 443** 
- Cloudflare is set to **â€œDNS onlyâ€** (gray cloud) for `mail.rishabhsoni.in`



goto

https://mail.rishabhsoni.in

or

http://192.168.1.29/

then
login as admin by
	Username: `admin`  
	Password: `moohoo`



## Setting Up Mailcow via GUI and Creating test@rishabhsoni.in

Once we have web access working through the tunnel, hereâ€™s what to do in Mailcow Admin UI:

### ðŸ§­ A. Log in to Mailcow Admin

- Visit `https://mail.rishabhsoni.in`
    

_No port forwarding neededâ€”tunneled web access_

### ðŸ‘¤ B. Add Your Domain

1. Go â†’ EMAIL -> **Configuration â†’ Mail Setup â†’ Domains**
    
2. Click **Add domain**
    
    - Domain: `rishabhsoni.in`
        
    - Enable: `DKIM`, `DMARC`, etc.
        
3. Save.




---
---
## â— Problem Summary

- **Mailcow** uses **Docker** and runs its **own nginx** on `80`/`443`.
    
- Your **Apache** websites also try to bind `80`/`443` â†’ **conflict**.
    
- Same thing happens with **GitLab** or anything that runs its own web stack in Docker.
    

## âœ… Solution: Use Apache as a Reverse Proxy

You already did this for GitLab â€” you'll now do the **same thing for Mailcow**.

Apache will:

- Bind to ports `80` and `443` as usual.
    
- Detect `Host: mail.rishabhsoni.in` traffic.
    
- Proxy that to Mailcowâ€™s **nginx inside Docker** (on internal port `8080` or similar).

## ðŸ›  Step-by-Step: Proxy Mailcow via Apache

### ðŸ”§ 1. Change Mailcow to Use Different Ports (to avoid conflict)

Edit `mailcow.conf` inside `/opt/mailcow-dockerized/`:

```bash
nano /opt/mailcow-dockerized/mailcow.conf
```

Find and change these:

```env
HTTP_PORT=8080
HTTPS_PORT=8443
```

> This makes Docker's internal nginx **avoid ports 80/443**, freeing them for Apache.

Then apply:

```bash
cd /opt/mailcow-dockerized
docker compose down
docker compose up -d
```

Now Mailcowâ€™s nginx listens on `8080` (HTTP) and `8443` (HTTPS) internally.

### âš™ 2. Apache Reverse Proxy for mail.rishabhsoni.in

In your Apache config (usually `/etc/apache2/sites-available/mailcow.conf`):

```apache
<VirtualHost *:80>
    ServerName mail.rishabhsoni.in

    ProxyPreserveHost On
    ProxyPass / http://localhost:8080/
    ProxyPassReverse / http://localhost:8080/
</VirtualHost>

<VirtualHost *:443>
    ServerName mail.rishabhsoni.in

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/rishabhsoni.in/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/rishabhsoni.in/privkey.pem

    ProxyPreserveHost On
    ProxyPass / https://localhost:8443/
    ProxyPassReverse / https://localhost:8443/
</VirtualHost>
```

Then enable it:

```bash
a2enmod proxy proxy_http ssl
a2ensite mailcow.conf
systemctl reload apache2
```

### ðŸ§ª Test

- Open `https://mail.rishabhsoni.in` in your browser.
    
- Should show Mailcow UI.
    
- Apache still serves your other websites (no conflict now).
## âœ… Recap

| Task                          | Purpose                                            |
| ----------------------------- | -------------------------------------------------- |
| Change Mailcow port           | Avoid clash with Apache                            |
| Apache proxy                  | Handle `mail.rishabhsoni.in` and forward to Docker |
| Keep Apache as primary server | Your websites continue to work                     |

---
----
